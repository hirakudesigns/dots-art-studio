<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTS ART STUDIO - Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --primary-color: #6c5ce7; --bg-color: #f0f2f5; --card-bg: #ffffff; --accent-color: #ff7675; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 10px; 
            overflow-x: hidden; 
            overflow-y: auto; 
        }

        .header-area {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 5px;
        }

        h1 { margin: 0; font-size: 1rem; color: var(--primary-color); font-weight: 800; letter-spacing: 1px; }

        /* 追従型メニューボタン */
        #openSidebar {
            position: fixed;
            right: 15px;
            top: 15px;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: var(--card-bg);
        }
        
        .app-container { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 15px; 
        }
        
        .canvas-area { 
            position: relative; width: 320px; height: 320px; 
            overflow: hidden; border: 4px solid var(--card-bg); border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #fff;
            touch-action: none; 
        }

        .canvas-wrapper { 
            position: absolute; transform-origin: 0 0; 
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%), linear-gradient(45deg, #eee 25%, #fff 25%, #fff 75%, #eee 75%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
        }
        canvas { image-rendering: pixelated; display: block; cursor: crosshair; }

        #gridOverlay {
            position: absolute; top: 0; left: 0; width: 320px; height: 320px;
            pointer-events: none; display: none;
            background-image: 
                linear-gradient(to right, rgba(0,0,0,0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.3) 1px, transparent 1px),
                linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 80px 80px, 80px 80px, 10px 10px, 10px 10px;
        }

        .quick-toolbar { 
            display: flex; 
            flex-direction: row; 
            justify-content: center;
            gap: 20px; 
            width: 100%;
        }
        .btn-round { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--card-bg); color: #57606f; box-shadow: 0 3px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* 画像アイコン用のスタイル */
        .img-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        /* 消しゴム画像だけ1.1倍に拡大（枠はそのまま） */
        #btn-eraser .img-icon {
            transform: scale(1.3);
        }

        /* アクティブな画像アイコンの色を反転 */
        .btn.active .img-icon {
            filter: brightness(0) invert(1);
        }

        .sidebar { position: fixed; top: 0; right: -280px; width: 240px; height: 100%; background: var(--card-bg); z-index: 1000; padding: 40px 15px 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.3s; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; }
        .sidebar.open { right: 0; }
        .sidebar .btn-text { width: 100%; min-height: 45px; font-weight: bold; display: flex; align-items: center; gap: 10px; border: none; background: #f1f2f6; border-radius: 10px; padding-left: 15px; cursor: pointer; color: #57606f; }

        .sns-button-container {
            margin-top: auto; padding: 15px 0; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; gap: 5px;
        }
        .sns-link { text-decoration: none; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.55rem; font-weight: bold; color: #57606f; }
        .sns-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .bg-line { background-color: #06C755; }
        .bg-x { background-color: #000000; }
        .bg-insta { background-image: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(108, 92, 231, 0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; display: none; }
        .overlay.active { display: block; }
        .bottom-controls { margin-top: 15px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 20px; box-sizing: border-box; }
        .row { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; align-items: center; }
        .btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; border-radius: 10px; background: #f1f2f6; color: #57606f; font-size: 0.75rem; }
        .btn.active { background: var(--primary-color); color: white; }
        
        .section-label { width: 100%; font-size: 0.65rem; color: #a1a1a1; font-weight: bold; margin-bottom: -2px; }
        .palette-container { display: flex; flex-wrap: wrap; gap: 10px; max-height: 80px; overflow-y: auto; padding: 5px; background: #f9f9f9; border-radius: 10px; }
        .palette-item { position: relative; width: 30px; height: 30px; }
        .palette-color { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .btn-del-color { position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: var(--accent-color); color: white; border-radius: 50%; border: none; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-upload { background: var(--primary-color); color: white; width: 100%; height: 55px; font-weight: 900; font-size: 1.1rem; border-radius: 15px; margin-top: 5px; letter-spacing: 2px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4); border: none; cursor: pointer; }
        .zoom-row { display: flex; align-items: center; gap: 10px; width: 100%; background: #f1f2f6; padding: 5px 15px; border-radius: 10px; box-sizing: border-box; }
        input[type="range"] { flex: 1; }
        select { height: 42px; border-radius: 10px; border: 1px solid #dfe4ea; padding: 0 5px; font-size: 0.8rem; }
        .library-item { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 8px; border-radius: 10px; margin-bottom: 5px; }
        .library-thumb { width: 40px; height: 40px; border: 1px solid #ddd; background: white; image-rendering: pixelated; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header-area">
        <h1>DOTS ART STUDIO</h1>
    </div>

    <button class="btn-round" id="openSidebar"><span class="material-icons">menu</span></button>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="font-weight:bold; font-size:1.2rem;">作品を送信中...</p>
    </div>

    <div class="app-container">
        <div class="canvas-area" id="canvasArea">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="dotCanvas" width="32" height="32" style="width: 320px; height: 320px;"></canvas>
                <div id="gridOverlay"></div>
            </div>
        </div>

        <div class="quick-toolbar">
            <button class="btn-round" id="btn-undo"><span class="material-icons">undo</span></button>
            <button class="btn-round" id="btn-redo"><span class="material-icons">redo</span></button>
            <button class="btn-round" id="btn-move" title="移動"><span class="material-icons">pan_tool</span></button>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="section-label">DISPLAY</div>
            <label style="font-size:0.85rem; font-weight:bold; display:flex; justify-content:space-between; align-items:center; color:#57606f;">
                グリッド線を表示 <input type="checkbox" id="gridSwitch">
            </label>
            <hr style="width:100%; border:0; border-top:1px solid #eee;">
            <div class="section-label">TRANSFORM</div>
            <button class="btn-text" id="btn-flip-h"><span class="material-icons">flip</span> 左右反転</button>
            <button class="btn-text" id="btn-flip-v"><span class="material-icons">swap_vert</span> 上下反転</button>
            <button class="btn-text" id="btn-rotate"><span class="material-icons">rotate_right</span> 90度回転</button>
            <button class="btn-text" id="btn-clear" style="color:var(--accent-color)"><span class="material-icons">delete_outline</span> 全消去</button>
            
            <div class="sns-button-container">
                <a href="https://lin.ee/CkQNe7q" class="sns-link" target="_blank">
                    <div class="sns-icon bg-line"><span class="material-icons">chat</span></div>
                    公式LINE
                </a>
                <a href="https://www.instagram.com/dots_projects/" class="sns-link" target="_blank">
                    <div class="sns-icon bg-insta"><span class="material-icons">camera_alt</span></div>
                    Insta
                </a>
                <a href="https://x.com/hiraku_designs" class="sns-link" target="_blank">
                    <div class="sns-icon bg-x"><span class="material-icons">close</span></div>
                    X
                </a>
            </div>
        </div>
        <div class="overlay" id="overlay"></div>
    </div>

    <div class="bottom-controls">
        <div class="section-label">ZOOM & MOVE</div>
        <div class="zoom-row">
            <span class="material-icons" style="font-size:18px">zoom_in</span>
            <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1">
            <button class="btn" id="btn-reset-zoom" style="width:auto; padding:0 10px; height:30px; font-size:0.7rem;">RESET</button>
        </div>

        <div class="section-label">TOOLS</div>
        <div class="row">
            <input type="color" id="colorPicker" value="#000000">
            <button class="btn active" id="btn-pen"><span class="material-icons">edit</span></button>
            <button class="btn" id="btn-eraser">
                <img src="erazer.png" class="img-icon" alt="Eraser">
            </button> 
            <button class="btn" id="btn-bucket"><span class="material-icons">format_color_fill</span></button>
            <button class="btn" id="btn-picker"><span class="material-icons">colorize</span></button>
        </div>

        <div class="section-label">PALETTE</div>
        <div class="row">
            <button class="btn" id="btn-add-palette" style="background:#55efc4; color:#00b894; width:auto; padding:0 12px; font-weight:bold;">COLORS +</button>
        </div>
        <div class="palette-container" id="paletteContainer"></div>

        <div class="section-label">EXPORT (DOWNLOAD)</div>
        <div class="row">
            <select id="sizeSelect">
                <option value="32">S (32px)</option>
                <option value="256" selected>M (256px)</option>
                <option value="512">L (512px)</option>
            </select>
            <button onclick="exportImage('png')" class="btn" style="background:#f1f2f6; width:55px; font-weight:bold;">PNG</button>
            <button onclick="exportImage('jpg')" class="btn" style="background:#f1f2f6; width:55px; font-weight:bold;">JPG</button>
        </div>

        <div class="section-label">LIBRARY STOCK (LOCAL SAVE)</div>
        <div class="row">
            <input type="text" id="artName" placeholder="作品の名前を入力..." style="flex:1; height:40px; border-radius:10px; border:2px solid #dfe4ea; padding:0 10px; font-size:0.9rem;">
            <button class="btn" id="btn-save-lib" style="background:#55efc4; color:#00b894; width:70px; font-weight:bold;">SAVE</button>
        </div>
        <div id="libraryList"></div>

        <div class="section-label">WORKSHOP SUBMISSION (OFFICIAL)</div>
        <button class="btn btn-upload" onclick="uploadImage()">UPLOAD 作品を提出する</button>
    </div>

    <script>
        const canvas = document.getElementById('dotCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');
        const canvasArea = document.getElementById('canvasArea');
        const zoomRange = document.getElementById('zoomRange');
        const colorPicker = document.getElementById('colorPicker');
        
        let scale = 1, offsetX = 0, offsetY = 0;
        let currentMode = 'pen', isDrawing = false;
        let colorPalette = [], library = [], historyStack = [], redoStack = [];

        const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyQfzImLPPswuEumZTx81SJHkPIuDS8qr8az4Xwv5N6LpgI7ETMdi6VZTQIt3pFkeIPQQ/exec";

        async function uploadImage() {
            const artNameField = document.getElementById('artName');
            const artName = artNameField.value.trim();
            if (!artName) { alert("作品名を入力してから提出してください！"); artNameField.focus(); return; }
            if (!confirm(`「${artName}」を公式作品として提出しますか？`)) return;

            const urlParams = new URLSearchParams(window.location.search);
            const fromSource = urlParams.get('from') || 'T';

            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            const exportSize = 512; 
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = tempCanvas.height = exportSize;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.drawImage(canvas, 0, 0, exportSize, exportSize);
            const imageData = tempCanvas.toDataURL('image/png');

            try {
                await fetch(GAS_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ image: imageData, name: artName, location: fromSource })
                });
                overlay.style.display = 'none';
                alert(`作品を送信しました！`);
                const formBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfNwyTLJ_-3FJx5oBbgzULdlWZ8TrVfyH6eHv5V4pXlAhP34Q/viewform";
                const question4Id = "46158305"; 
                window.location.href = `${formBaseUrl}?usp=pp_url&entry.${question4Id}=${encodeURIComponent(artName)}`;
            } catch (e) {
                overlay.style.display = 'none';
                alert("送信に失敗しました。");
            }
        }

        function updateTransform() { wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`; }
        zoomRange.oninput = () => { scale = parseFloat(zoomRange.value); updateTransform(); };
        document.getElementById('btn-reset-zoom').onclick = () => { scale = 1; offsetX = 0; offsetY = 0; zoomRange.value = 1; updateTransform(); };

        let isMoving = false, startX, startY;
        canvasArea.onmousedown = canvasArea.ontouchstart = (e) => {
            if (currentMode === 'move') { isMoving = true; const p = e.touches ? e.touches[0] : e; startX = p.clientX - offsetX; startY = p.clientY - offsetY; return; }
            isDrawing = true; handleAction(e);
        };
        window.onmousemove = window.ontouchmove = (e) => {
            if (isMoving) { const p = e.touches ? e.touches[0] : e; offsetX = p.clientX - startX; offsetY = p.clientY - startY; updateTransform(); }
            else if (isDrawing && currentMode !== 'bucket' && currentMode !== 'move') handleAction(e);
        };
        window.onmouseup = window.ontouchend = () => { isMoving = false; if (isDrawing) { isDrawing = false; saveHistory(); } };

        function handleAction(e) {
            const rect = canvas.getBoundingClientRect();
            const p = e.touches ? e.touches[0] : e;
            const x = Math.floor((p.clientX - rect.left) / (rect.width / 32));
            const y = Math.floor((p.clientY - rect.top) / (rect.height / 32));
            if (x < 0 || x >= 32 || y < 0 || y >= 32) return;
            if (currentMode === 'pen') { ctx.fillStyle = colorPicker.value; ctx.fillRect(x, y, 1, 1); }
            else if (currentMode === 'eraser') ctx.clearRect(x, y, 1, 1);
            else if (currentMode === 'picker') { 
                const d = ctx.getImageData(x, y, 1, 1).data; 
                if (d[3] !== 0) colorPicker.value = "#" + [d[0], d[1], d[2]].map(x => x.toString(16).padStart(2, '0')).join(''); 
            }
            else if (currentMode === 'bucket') floodFill(x, y, colorPicker.value);
        }

        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        document.getElementById('openSidebar').onclick = () => { sidebar.classList.add('open'); overlay.classList.add('active'); };
        overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); };
        document.getElementById('gridSwitch').onchange = (e) => { document.getElementById('gridOverlay').style.display = e.target.checked ? 'block' : 'none'; };

        const toolBtns = { pen: 'btn-pen', eraser: 'btn-eraser', bucket: 'btn-bucket', picker: 'btn-picker', move: 'btn-move' };
        Object.keys(toolBtns).forEach(m => {
            document.getElementById(toolBtns[m]).onclick = () => {
                currentMode = m;
                Object.values(toolBtns).forEach(id => document.getElementById(id).classList.remove('active'));
                document.getElementById(toolBtns[m]).classList.add('active');
            };
        });

        function floodFill(startX, startY, fillColor) {
            const targetData = ctx.getImageData(startX, startY, 1, 1).data;
            const targetColor = `rgba(${targetData[0]},${targetData[1]},${targetData[2]},${targetData[3]})`;
            ctx.fillStyle = fillColor; const stack = [[startX, startY]]; const visited = new Set();
            while(stack.length) {
                const [x, y] = stack.pop(); if (x < 0 || x >= 32 || y < 0 || y >= 32 || visited.has(`${x},${y}`)) continue;
                const d = ctx.getImageData(x, y, 1, 1).data;
                if (`rgba(${d[0]},${d[1]},${d[2]},${d[3]})` === targetColor) { ctx.fillRect(x, y, 1, 1); visited.add(`${x},${y}`); stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]); }
            }
        }

        function saveHistory() { historyStack.push(canvas.toDataURL()); if (historyStack.length > 30) historyStack.shift(); redoStack = []; localStorage.setItem('dotsAppData', canvas.toDataURL()); }
        function loadImg(u) { const i = new Image(); i.src = u; i.onload = () => { ctx.clearRect(0, 0, 32, 32); ctx.drawImage(i, 0, 0); }; }
        document.getElementById('btn-undo').onclick = () => { if (historyStack.length > 1) { redoStack.push(historyStack.pop()); loadImg(historyStack[historyStack.length - 1]); } };
        document.getElementById('btn-redo').onclick = () => { if (redoStack.length) { const s = redoStack.pop(); historyStack.push(s); loadImg(s); } };

        function renderPalette() {
            const pc = document.getElementById('paletteContainer'); pc.innerHTML = '';
            colorPalette.forEach((c, i) => {
                const w = document.createElement('div'); w.className = 'palette-item';
                w.innerHTML = `<div class="palette-color" style="background:${c}" onclick="document.getElementById('colorPicker').value='${c}'"></div>
                               <button class="btn-del-color" onclick="deletePaletteColor(${i})">×</button>`;
                pc.appendChild(w);
            });
        }
        window.deletePaletteColor = (i) => { colorPalette.splice(i, 1); localStorage.setItem('dotsAppPalette', JSON.stringify(colorPalette)); renderPalette(); };
        document.getElementById('btn-add-palette').onclick = () => { const c = colorPicker.value.toLowerCase(); if(!colorPalette.includes(c)){ colorPalette.push(c); renderPalette(); localStorage.setItem('dotsAppPalette', JSON.stringify(colorPalette)); } };

        function renderLibrary() {
            const ll = document.getElementById('libraryList'); ll.innerHTML = '';
            library.forEach((item, i) => {
                const div = document.createElement('div'); div.className = 'library-item';
                div.innerHTML = `<img src="${item.data}" class="library-thumb" onclick="loadImg('${item.data}')">
                                 <span style="flex:1; font-size:0.8rem; font-weight:bold;">${item.name}</span>
                                 <button class="btn" onclick="deleteLib(${i})" style="width:30px; height:30px; color:red; font-weight:bold;">×</button>`;
                ll.appendChild(div);
            });
        }
        document.getElementById('btn-save-lib').onclick = () => {
            const name = document.getElementById('artName').value || "無題";
            library.push({ name: name, data: canvas.toDataURL() });
            localStorage.setItem('dotsAppLib', JSON.stringify(library)); renderLibrary();
        };
        window.deleteLib = (i) => { if(confirm("消去しますか？")) { library.splice(i, 1); localStorage.setItem('dotsAppLib', JSON.stringify(library)); renderLibrary(); } };

        function exportImage(format) {
            const s = parseInt(document.getElementById('sizeSelect').value);
            const tc = document.createElement('canvas'); tc.width = tc.height = s;
            const tx = tc.getContext('2d'); tx.imageSmoothingEnabled = false;
            if (format === 'jpg') { tx.fillStyle = "#fff"; tx.fillRect(0, 0, s, s); }
            tx.drawImage(canvas, 0, 0, s, s);
            const a = document.createElement('a'); a.download = `art.${format}`; a.href = tc.toDataURL(format === 'jpg' ? 'image/jpeg' : 'image/png'); a.click();
        }

        function transform(action) {
            const temp = document.createElement('canvas'); temp.width = 32; temp.height = 32; const tCtx = temp.getContext('2d');
            if (action === 'flip-h') { tCtx.scale(-1, 1); tCtx.drawImage(canvas, -32, 0); }
            else if (action === 'flip-v') { tCtx.scale(1, -1); tCtx.drawImage(canvas, 0, -32); }
            else if (action === 'rotate') { tCtx.translate(16, 16); tCtx.rotate(Math.PI / 2); tCtx.drawImage(canvas, -16, -16); }
            ctx.clearRect(0, 0, 32, 32); ctx.drawImage(temp, 0, 0); saveHistory();
        }
        document.getElementById('btn-flip-h').onclick = () => transform('flip-h');
        document.getElementById('btn-flip-v').onclick = () => transform('flip-v');
        document.getElementById('btn-rotate').onclick = () => transform('rotate');
        document.getElementById('btn-clear').onclick = () => { if(confirm("キャンバスをすべて消去しますか？")) { ctx.clearRect(0, 0, 32, 32); saveHistory(); } };

        window.onload = () => {
            const d = localStorage.getItem('dotsAppData'), p = localStorage.getItem('dotsAppPalette'), l = localStorage.getItem('dotsAppLib');
            if(d) loadImg(d); 
            if(p) { colorPalette = JSON.parse(p); renderPalette(); }
            if(l) { library = JSON.parse(l); renderLibrary(); }
            saveHistory();
        };
    </script>
</body>
</html>
